<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Attendance & Scaffolding Tracker</title>
<style>
  :root{
    --bg:#f7f8fb; --card:#ffffff; --accent:#0b78d1; --danger:#d0393e; --muted:#6b7280;
  }
  html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;}
  body{background:var(--bg);color:#111;}
  .app{max-width:720px;margin:0 auto;padding:12px;}
  header{display:flex;align-items:center;justify-content:space-between;padding:12px 0;}
  h1{font-size:1.1rem;margin:0;}
  .sup-info{font-size:.9rem;color:var(--muted);}
  main{display:block;gap:12px;}
  .card{background:var(--card);border-radius:12px;padding:12px;margin-bottom:12px;box-shadow:0 1px 3px rgba(0,0,0,0.06);}
  .big-btn{display:block;width:100%;padding:14px;border-radius:10px;border:0;font-size:1rem;background:var(--accent);color:#fff}
  .flow-btn{display:flex;gap:8px;align-items:center;padding:12px;border-radius:10px;border:1px solid #e6e9ee;background:#fff}
  label{display:block;font-size:.85rem;margin-bottom:6px;color:var(--muted);}
  select,input[type="text"],input[type="number"],textarea{width:100%;padding:10px;border-radius:8px;border:1px solid #e6e9ee;font-size:1rem;background:transparent;box-sizing:border-box}
  .row{display:flex;gap:8px}
  .col{flex:1;}
  .muted{color:var(--muted);font-size:.9rem}
  .small{font-size:.85rem}
  .link-btn{background:transparent;border:0;color:var(--accent);padding:0;font-size:.95rem}
  .danger{background:var(--danger);color:#fff;border:0;padding:10px;border-radius:8px}
  .inline-error{color:var(--danger);font-size:.85rem;margin-top:6px}
  .entries{display:flex;flex-direction:column;gap:10px}
  .entry{padding:8px;border-radius:8px;border:1px dashed #e6e9ee}
  .actions{display:flex;gap:8px;margin-top:12px}
  .report{white-space:pre-wrap;background:#f1f5f9;padding:12px;border-radius:8px;font-family:monospace;font-size:.95rem}
  footer{font-size:.8rem;color:var(--muted);text-align:center;padding:18px 0;}
  @media(min-width:600px){h1{font-size:1.25rem}}
</style>
</head>
<body>
<div class="app" id="app">
  <header>
    <div>
      <h1>Attendance & Scaffolding Tracker</h1>
      <div id="supInfo" class="sup-info">Not signed in</div>
    </div>
    <div>
      <button id="signOutBtn" class="link-btn" style="display:none">Sign out</button>
    </div>
  </header>

  <main>
    <div id="loginCard" class="card">
      <div style="display:flex;flex-direction:column;gap:8px">
        <label>Supervisor Username</label>
        <input id="username" type="text" inputmode="text" autocomplete="username" />
        <label>Passcode</label>
        <input id="passcode" type="password" inputmode="numeric" autocomplete="current-password" />
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="loginBtn" class="big-btn">Sign In</button>
        </div>
        <div id="loginError" class="inline-error" style="display:none"></div>
      </div>
    </div>

    <div id="landing" class="card" style="display:none">
      <div class="muted small">Choose flow</div>
      <div style="display:flex;flex-direction:column;gap:8px;margin-top:8px">
        <button id="openCheckIn" class="flow-btn">Check-In (Quick)</button>
        <button id="openCheckOut" class="flow-btn">Check-Out / Daily Report</button>
      </div>
    </div>

    <!-- Check-In Flow -->
    <div id="checkInCard" class="card" style="display:none">
      <div class="muted small">Check-In</div>
      <div style="margin-top:8px">
        <label>Project</label>
        <select id="ciProject"></select>
        <label>Worker</label>
        <select id="ciWorker"></select>
        <label>Notes (optional)</label>
        <textarea id="ciNotes" rows="2"></textarea>
        <div class="actions">
          <button id="ciConfirm" class="big-btn">Submit Check-In</button>
          <button id="ciCancel" class="link-btn">Cancel</button>
        </div>
        <div id="ciError" class="inline-error" style="display:none"></div>
      </div>
      <div id="ciResult" style="display:none;margin-top:10px">
        <div class="report" id="ciReportText"></div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="ciCopy" class="big-btn" style="flex:1">Copy Report</button>
          <button id="ciShare" class="big-btn" style="flex:1;background:#25D366">Share WhatsApp</button>
        </div>
      </div>
    </div>

    <!-- Check-Out Flow -->
    <div id="checkOutCard" class="card" style="display:none">
      <div class="muted small">Check-Out / Daily Report</div>
      <div style="margin-top:8px">
        <label>Project</label>
        <select id="coProject"></select>

        <div style="display:flex;gap:8px;margin-top:8px;align-items:center">
          <div class="muted small">Entries</div>
          <button id="addEntry" class="link-btn" style="margin-left:auto">+ Add Entry</button>
        </div>

        <div id="entriesContainer" class="entries" style="margin-top:8px"></div>

        <div style="margin-top:8px">
          <label>Total Manpower</label>
          <input id="totalManpower" type="number" min="0" step="1" />
          <label>Total OT Hours</label>
          <input id="totalOTHours" type="number" min="0" step="0.1" />
        </div>

        <div style="margin-top:8px">
          <label>Notes (optional)</label>
          <textarea id="coNotes" rows="2"></textarea>
        </div>

        <div class="actions">
          <button id="coConfirm" class="big-btn">Submit Daily Report</button>
          <button id="coCancel" class="link-btn">Cancel</button>
        </div>
        <div id="coError" class="inline-error" style="display:none"></div>
      </div>

      <div id="coResult" style="display:none;margin-top:10px">
        <div class="report" id="coReportText"></div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="coCopy" class="big-btn" style="flex:1">Copy Report</button>
          <button id="coShare" class="big-btn" style="flex:1;background:#25D366">Share WhatsApp</button>
        </div>
      </div>
    </div>

    <div id="loading" class="card" style="display:none">
      <div class="muted">Loadingâ€¦</div>
    </div>

  </main>

  <footer>
    Tips: Use small taps, choose project first. After deploying Apps Script, set WEB_APP_URL in the top of this file (see README).
  </footer>
</div>

<script>
/*
  index.html (frontend)
  - Configure WEB_APP_URL after deploying your Apps Script web app (see README)
  - The frontend uses simple fetch() to call the web app endpoints.
*/

const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzvVEu0jcARC0gWdY-Gy4w-HFo5h-tZ3bbKK2q3OP9hkTDTrbX87bucKfO-grBT3ws/exec"; // e.g. https://script.google.com/macros/s/XXX/exec
// End user: replace above with published Apps Script URL.

const qs = s=>document.querySelector(s);

let state = {
  supervisor: null, // {Username, SupervisorName, Email}
  projects: [],
  workersCache: {}, // projectId -> workers[]
  areasCache: {},   // projectId -> areas[]
};

function show(el){ el.style.display = ""; }
function hide(el){ el.style.display = "none"; }
function setText(el,txt){ el.textContent = txt; }

async function apiGet(params){
  // params is an object of query parameters
  const url = new URL(WEB_APP_URL);
  Object.keys(params||{}).forEach(k=>url.searchParams.set(k, params[k]));
  const res = await fetch(url.toString());
  const js = await res.json();
  if(js.error) throw new Error(js.error);
  return js;
}

async function apiPost(action, payload){
  const url = new URL(WEB_APP_URL);
  url.searchParams.set("action", action);
  const res = await fetch(url.toString(), {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify(payload)
  });
  const js = await res.json();
  if(js.error) throw new Error(js.error);
  return js;
}

/* UI helpers */
function populateSelect(selectEl, list, valueKey, labelFn, includeBlank){
  selectEl.innerHTML = "";
  if(includeBlank) selectEl.appendChild(new Option("-- select --",""));
  list.forEach(it=>{
    const opt = new Option(labelFn(it), it[valueKey]);
    selectEl.appendChild(opt);
  });
}

/* Login */
qs("#loginBtn").addEventListener("click", login);
qs("#signOutBtn").addEventListener("click", signOut);

async function login(){
  const username = qs("#username").value.trim();
  const passcode = qs("#passcode").value.trim();
  qs("#loginError").style.display = "none";
  if(!username || !passcode){
    qs("#loginError").textContent = "Enter username and passcode";
    qs("#loginError").style.display = "";
    return;
  }
  try{
    show(qs("#loading"));
    const resp = await apiPost("verifyLogin",{username, passcode});
    state.supervisor = resp.supervisor;
    sessionStorage.setItem("sup", JSON.stringify(state.supervisor));
    afterLogin();
    await loadProjects();
  }catch(err){
    qs("#loginError").textContent = err.message;
    qs("#loginError").style.display = "";
  }finally{ hide(qs("#loading")); }
}

function signOut(){
  state.supervisor = null;
  sessionStorage.removeItem("sup");
  qs("#supInfo").textContent = "Not signed in";
  hide(qs("#landing"));
  hide(qs("#checkInCard"));
  hide(qs("#checkOutCard"));
  show(qs("#loginCard"));
  hide(qs("#signOutBtn"));
  qs("#username").value=""; qs("#passcode").value="";
}

/* After login state */
function afterLogin(){
  const s = state.supervisor;
  qs("#supInfo").textContent = `${s.SupervisorName} (${s.Username})`;
  show(qs("#signOutBtn"));
  hide(qs("#loginCard"));
  show(qs("#landing"));
  // restore last chosen project if any
}

/* Load projects */
async function loadProjects(){
  try{
    show(qs("#loading"));
    const resp = await apiGet({action:"getProjects"});
    state.projects = resp.projects || [];
    // populate project selects
    const ciProject = qs("#ciProject");
    const coProject = qs("#coProject");
    populateSelect(ciProject, state.projects, "ProjectID", p=>`${p.ProjectName} (${p.ProjectID})`, true);
    populateSelect(coProject, state.projects, "ProjectID", p=>`${p.ProjectName} (${p.ProjectID})`, true);
  }catch(err){
    alert("Failed to load projects: " + err.message);
  }finally{ hide(qs("#loading")); }
}

/* Landing actions */
qs("#openCheckIn").addEventListener("click",()=>{
  hide(qs("#landing"));
  show(qs("#checkInCard"));
  qs("#ciResult").style.display="none";
});
qs("#openCheckOut").addEventListener("click",()=>{
  hide(qs("#landing"));
  show(qs("#checkOutCard"));
  qs("#coResult").style.display="none";
});

/* Check-In logic */
qs("#ciProject").addEventListener("change", async function(){
  const pid = this.value;
  if(!pid) return;
  await loadWorkersForProject(pid);
  populateSelect(qs("#ciWorker"), state.workersCache[pid]||[], "EmpCode", w=>`${w.WorkerName} (${w.EmpCode})`, true);
});

async function loadWorkersForProject(pid){
  if(state.workersCache[pid]) return;
  try{
    const resp = await apiGet({action:"getWorkers", projectId:pid});
    state.workersCache[pid] = resp.workers || [];
  }catch(err){
    alert("Failed to load workers: " + err.message);
  }
}

qs("#ciCancel").addEventListener("click", ()=>{
  hide(qs("#checkInCard")); show(qs("#landing"));
});

qs("#ciConfirm").addEventListener("click", async ()=>{
  qs("#ciError").style.display = "none";
  const projectId = qs("#ciProject").value;
  const empCode = qs("#ciWorker").value;
  const notes = qs("#ciNotes").value.trim();
  if(!projectId || !empCode){
    qs("#ciError").textContent = "Select project and worker.";
    qs("#ciError").style.display = "";
    return;
  }
  try{
    show(qs("#loading"));
    const payload = {
      supervisorUsername: state.supervisor.Username,
      projectId, empCode, notes
    };
    const resp = await apiPost("submitCheckIn", payload);
    // show report
    qs("#ciReportText").textContent = resp.reportText;
    show(qs("#ciResult"));
  }catch(err){
    qs("#ciError").textContent = err.message;
    qs("#ciError").style.display = "";
  }finally{ hide(qs("#loading")); }
});

qs("#ciCopy").addEventListener("click", async ()=>{
  const text = qs("#ciReportText").textContent || "";
  try{
    await navigator.clipboard.writeText(text);
    alert("Copied to clipboard");
  }catch(e){ alert("Copy failed"); }
});

qs("#ciShare").addEventListener("click", ()=>{
  const text = qs("#ciReportText").textContent || "";
  const url = "https://wa.me/?text=" + encodeURIComponent(text);
  window.open(url, "_blank");
});

/* Check-Out logic */
qs("#coProject").addEventListener("change", async function(){
  const pid = this.value;
  if(!pid) return;
  await loadWorkersForProject(pid);
  await loadAreasForProject(pid);
  rebuildAllWorkerSelects();
  rebuildAreaSelects();
});

async function loadAreasForProject(pid){
  if(state.areasCache[pid]) return;
  try{
    const resp = await apiGet({action:"getAreas", projectId:pid});
    state.areasCache[pid] = resp.areas || [];
  }catch(err){
    alert("Failed to load areas: " + err.message);
  }
}

/* Entries UI (dynamic) */
qs("#addEntry").addEventListener("click", addEntry);
function addEntry(prefill){
  const container = qs("#entriesContainer");
  const div = document.createElement("div");
  div.className = "entry";

  div.innerHTML = `
    <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
      <div style="flex:1">
        <label>Area</label>
        <select class="areaSelect"></select>
      </div>
      <div style="width:120px">
        <label>Job Type</label>
        <select class="jobType">
          <option value="Erection">Erection</option>
          <option value="Dismantling">Dismantling</option>
        </select>
      </div>
      <button class="removeEntry link-btn" title="Remove" style="margin-top:22px">Remove</button>
    </div>

    <div style="display:flex;gap:8px">
      <div class="col">
        <label>L (m)</label><input class="L" type="number" min="0" step="0.01"/>
      </div>
      <div class="col">
        <label>W (m)</label><input class="W" type="number" min="0" step="0.01"/>
      </div>
      <div class="col">
        <label>H (m)</label><input class="H" type="number" min="0" step="0.01"/>
      </div>
    </div>

    <div style="display:flex;gap:8px;margin-top:8px">
      <div style="width:120px">
        <label>Q</label><input class="Q" type="number" min="1" step="1" value="1"/>
      </div>
      <div style="width:120px">
        <label>Manpower</label><input class="Manpower" type="number" min="0" step="1" value="1"/>
      </div>
      <div style="flex:1">
        <label>Workers OT (comma EmpCodes or pick)</label>
        <input class="WorkersOT" type="text" placeholder="E123, E456" />
      </div>
    </div>

    <div style="display:flex;gap:8px;margin-top:8px;align-items:center">
      <div style="flex:1">
        <label>OT Hours (sum for this entry)</label>
        <input class="OTHours" type="number" min="0" step="0.1" value="0"/>
      </div>
      <div style="width:150px">
        <label>Volume (calc)</label>
        <div class="muted small calcVolume">0</div>
      </div>
    </div>
  `;

  container.appendChild(div);

  // wire up remove and onchange handlers
  div.querySelector(".removeEntry").addEventListener("click", ()=>{
    div.remove();
  });

  const selects = div.querySelectorAll("select, input");
  selects.forEach(s=>s.addEventListener("input", ()=> updateVolume(div)));

  // populate area & worker selects
  rebuildAreaSelectFor(div);
  rebuildAllWorkerSelects(); // for guidance if you later add worker dropdowns
  if(prefill){
    // optionally prefill fields
    if(prefill.jobType) div.querySelector(".jobType").value = prefill.jobType;
  }
  updateVolume(div);
}

function rebuildAreaSelectFor(div){
  const pid = qs("#coProject").value;
  const list = state.areasCache[pid] || [];
  const sel = div.querySelector(".areaSelect");
  sel.innerHTML = "";
  sel.appendChild(new Option("-- select area --",""));
  list.forEach(a=>{
    sel.appendChild(new Option(`${a.AreaName} (${a.AreaID})`, a.AreaID));
  });
}

function rebuildAreaSelects(){
  document.querySelectorAll(".entry").forEach(div=>rebuildAreaSelectFor(div));
}

function rebuildAllWorkerSelects(){
  // In this simplified UI we use a free input for WorkersOT, so nothing required.
}

function updateVolume(div){
  const L = parseFloat(div.querySelector(".L").value) || 0;
  const W = parseFloat(div.querySelector(".W").value) || 0;
  const H = parseFloat(div.querySelector(".H").value) || 0;
  const Q = parseInt(div.querySelector(".Q").value) || 0;
  const job = div.querySelector(".jobType").value;
  let vol = L*W*H*Q;
  if(job === "Dismantling") vol = vol/2;
  div.querySelector(".calcVolume").textContent = vol.toFixed(3);
}

/* gather entries */
function gatherEntries(){
  const pid = qs("#coProject").value;
  const entries = [];
  const divs = Array.from(document.querySelectorAll(".entry"));
  for(const div of divs){
    const areaId = div.querySelector(".areaSelect").value || "";
    const areaName = div.querySelector(".areaSelect").selectedOptions[0] ? div.querySelector(".areaSelect").selectedOptions[0].text : "";
    const jobType = div.querySelector(".jobType").value;
    const L = parseFloat(div.querySelector(".L").value) || 0;
    const W = parseFloat(div.querySelector(".W").value) || 0;
    const H = parseFloat(div.querySelector(".H").value) || 0;
    const Q = parseInt(div.querySelector(".Q").value) || 0;
    const Manpower = parseInt(div.querySelector(".Manpower").value) || 0;
    const WorkersOT = div.querySelector(".WorkersOT").value.trim();
    const OT_Hours = parseFloat(div.querySelector(".OTHours").value) || 0;

    entries.push({
      areaId, areaName, jobType, L, W, H, Q, Manpower, WorkersOT, OT_Hours
    });
  }
  return entries;
}

/* Confirm / submit checkout */
qs("#coConfirm").addEventListener("click", async ()=>{
  qs("#coError").style.display = "none";
  const projectId = qs("#coProject").value;
  if(!projectId){ qs("#coError").textContent = "Select project"; qs("#coError").style.display = ""; return; }
  const entries = gatherEntries();
  if(entries.length === 0){ qs("#coError").textContent = "Add at least one entry"; qs("#coError").style.display = ""; return; }
  // basic validation
  for(const [i,en] of entries.entries()){
    if(en.Q < 1) { qs("#coError").textContent = `Entry ${i+1}: Q must be at least 1`; qs("#coError").style.display = ""; return; }
    if(en.L < 0 || en.W < 0 || en.H < 0) { qs("#coError").textContent = `Entry ${i+1}: dimensions must be >= 0`; qs("#coError").style.display = ""; return; }
  }

  // totals from UI or compute
  const totalManpower = parseInt(qs("#totalManpower").value) || entries.reduce((s,e)=>s+e.Manpower,0);
  const totalOTHours = parseFloat(qs("#totalOTHours").value) || entries.reduce((s,e)=>s+e.OT_Hours,0);

  // submit
  try{
    show(qs("#loading"));
    const payload = {
      supervisorUsername: state.supervisor.Username,
      projectId,
      entries,
      totalManpower,
      totalOTHours,
      notes: qs("#coNotes").value.trim()
    };
    const resp = await apiPost("submitCheckOut", payload);
    qs("#coReportText").textContent = resp.reportText;
    show(qs("#coResult"));
  }catch(err){
    qs("#coError").textContent = err.message;
    qs("#coError").style.display = "";
  }finally{ hide(qs("#loading")); }
});

qs("#coCopy").addEventListener("click", async ()=>{
  const text = qs("#coReportText").textContent || "";
  try{
    await navigator.clipboard.writeText(text);
    alert("Copied to clipboard");
  }catch(e){ alert("Copy failed"); }
});
qs("#coShare").addEventListener("click", ()=>{
  const text = qs("#coReportText").textContent || "";
  const url = "https://wa.me/?text=" + encodeURIComponent(text);
  window.open(url, "_blank");
});

qs("#coCancel").addEventListener("click", ()=>{
  hide(qs("#checkOutCard")); show(qs("#landing"));
});

/* Initialization */
(function init(){
  // restore supervisor from sessionStorage if present
  const sup = sessionStorage.getItem("sup");
  if(sup){
    try{
      state.supervisor = JSON.parse(sup);
      afterLogin();
      loadProjects();
    }catch(e){}
  }
  // wire initial quick-check: when project is changed in CI, ensure workers loaded
})();
</script>
</body>
</html>
