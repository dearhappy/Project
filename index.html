<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Worker Check-in App</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f4f7f6; display: flex; align-items: center; min-height: 100vh; padding: 10px; }
        .card { border: none; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); width: 100%; max-width: 400px; margin: auto; }
        .hidden { display: none; }
        #loader { font-size: 0.8rem; color: #666; }
        .list-group-item { font-size: 0.9rem; border-left: 4px solid #0d6efd; margin-bottom: 5px; border-radius: 5px !important; }
    </style>
</head>
<body>

<div class="card p-4">
    <h5 class="text-center fw-bold mb-4 text-primary">ATTENDANCE CHECK-IN</h5>
    
    <div id="loader" class="text-center mb-3">Initializing App...</div>

    <div id="loginSec" class="hidden">
        <input type="text" id="username" class="form-control mb-2" placeholder="Username">
        <input type="password" id="passcode" class="form-control mb-3" placeholder="Passcode">
        <button class="btn btn-primary w-100" onclick="handleLogin()">Login</button>
    </div>

    <div id="mainSec" class="hidden">
        <p class="small mb-2">Welcome: <b id="supName"></b></p>
        
        <label class="small text-muted">Select Area</label>
        <select id="areaDrop" class="form-select mb-3"></select>

        <label class="small text-muted">Worker List</label>
        <select id="workerDrop" class="form-select mb-2"></select>
        <button class="btn btn-outline-primary btn-sm w-100 mb-3" onclick="addWorkerToList()">+ Add to List</button>

        <h6 class="small fw-bold">Ready to Check-in:</h6>
        <ul id="checkinList" class="list-group mb-3 p-0"></ul>

        <button class="btn btn-success w-100" id="subBtn" onclick="finalSubmit()">Submit & Share Report</button>
    </div>
</div>

<script>
    // 1. UPDATE THIS URL AFTER DEPLOYING GAS
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzvVEu0jcARC0gWdY-Gy4w-HFo5h-tZ3bbKK2q3OP9hkTDTrbX87bucKfO-grBT3ws/exec";
    
    let db = { users: [], areas: [], workers: [] };
    let tempWorkers = [];

    // Auto-load data on start
    window.onload = () => {
        fetch(WEB_APP_URL, {
            method: "POST",
            body: JSON.stringify({ action: "getData" })
        })
        .then(res => res.json())
        .then(data => {
            db = data;
            const aD = document.getElementById('areaDrop');
            db.areas.forEach(a => aD.innerHTML += `<option value="${a}">${a}</option>`);
            
            const wD = document.getElementById('workerDrop');
            db.workers.forEach(w => wD.innerHTML += `<option value="${w.code}">${w.name} [${w.code}]</option>`);
            
            document.getElementById('loader').classList.add('hidden');
            document.getElementById('loginSec').classList.remove('hidden');
        })
        .catch(err => alert("Error loading data. Check Web App URL."));
    };

    function handleLogin() {
        const u = document.getElementById('username').value;
        const p = document.getElementById('passcode').value;
        if(db.users.find(x => x.user === u && x.pass === p)) {
            document.getElementById('supName').innerText = u;
            document.getElementById('loginSec').classList.add('hidden');
            document.getElementById('mainSec').classList.remove('hidden');
        } else {
            alert("Invalid Login");
        }
    }

    function addWorkerToList() {
        const sel = document.getElementById('workerDrop');
        const code = sel.value;
        const name = sel.options[sel.selectedIndex].text.split(' [')[0];
        
        if(!tempWorkers.some(w => w.code === code)) {
            tempWorkers.push({ name, code });
            renderList();
        }
    }

    function renderList() {
        const list = document.getElementById('checkinList');
        list.innerHTML = tempWorkers.map((w, i) => `
            <li class="list-group-item d-flex justify-content-between align-items-center">
                ${i+1}. ${w.name}
                <span class="text-danger" style="cursor:pointer" onclick="removeWorker(${i})">âœ•</span>
            </li>
        `).join('');
    }

    function removeWorker(i) {
        tempWorkers.splice(i, 1);
        renderList();
    }

    function finalSubmit() {
        if(tempWorkers.length === 0) return alert("Add workers first");
        
        const btn = document.getElementById('subBtn');
        btn.disabled = true;
        btn.innerText = "Saving...";

        const payload = {
            action: "submit",
            data: {
                supervisor: document.getElementById('username').value,
                area: document.getElementById('areaDrop').value,
                workers: tempWorkers
            }
        };

        fetch(WEB_APP_URL, {
            method: "POST",
            mode: "no-cors", // Required for cross-domain Google Script
            body: JSON.stringify(payload)
        }).then(() => {
            generateShareLink(payload.data);
        }).catch(() => alert("Submission failed."));
    }

    function generateShareLink(data) {
        const date = new Date().toLocaleDateString();
        let report = `CHECK IN REPORT\nDate: ${date}\nSupervisor: ${data.supervisor}\nArea: ${data.area}\n\n`;
        data.workers.forEach((w, i) => {
            report += `${i + 1}. ${w.name}\n`;
        });

        const waUrl = `https://api.whatsapp.com/send?text=${encodeURIComponent(report)}`;
        window.open(waUrl, '_blank');
        location.reload();
    }
</script>

</body>
</html>
