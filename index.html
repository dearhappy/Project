<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>Worker Attendance & Scaffolding Report</title>
    <style>
        /* Mobile-First Base Styles */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f7f6;
            color: #333;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 15px;
        }
        header {
            background-color: #007bff;
            color: white;
            padding: 15px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            font-size: 1.5em;
            margin: 0;
        }
        /* Buttons & Forms */
        button, input[type="submit"], .btn {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 15px 20px;
            text-align: center;
            text-decoration: none;
            display: block;
            font-size: 1em;
            margin: 10px 0;
            cursor: pointer;
            border-radius: 8px;
            width: 100%;
            box-sizing: border-box;
            transition: background-color 0.3s;
        }
        button:hover:not(:disabled), input[type="submit"]:hover:not(:disabled), .btn:hover:not(:disabled) {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        input[type="text"], input[type="password"], input[type="number"], select {
            width: 100%;
            padding: 12px;
            margin: 8px 0 15px 0;
            display: inline-block;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 1em;
        }
        label {
            display: block;
            margin-top: 10px;
            font-weight: bold;
        }
        .message, .error {
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .hidden {
            display: none;
        }

        /* Flow Specific */
        .scaffolding-entry {
            border: 1px solid #ddd;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 6px;
            background-color: white;
            position: relative;
        }
        .remove-entry {
            position: absolute;
            top: 5px;
            right: 5px;
            background: none;
            border: none;
            color: #dc3545;
            font-size: 1.5em;
            padding: 0;
            margin: 0;
            width: auto;
            display: inline-block;
        }
        .ot-worker-box {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        .ot-worker-box select, .ot-worker-box input {
            flex-grow: 1;
            margin: 0;
        }
    </style>
</head>
<body>
    <header>
        <h1 id="app-title">Scaffolding Reporter</h1>
        <div id="supervisor-info"></div>
    </header>

    <div class="container">
        <div id="app-container">

            <div id="login-screen" class="screen">
                <h2>Supervisor Login</h2>
                <div id="login-error" class="error hidden"></div>
                <label for="username">Username</label>
                <input type="text" id="username" placeholder="Enter your username">

                <label for="passcode">Passcode</label>
                <input type="password" id="passcode" placeholder="Enter your passcode">

                <button onclick="handleLogin()">Login</button>
            </div>

            <div id="main-menu" class="screen hidden">
                <h2 id="welcome-message"></h2>
                <button onclick="showFlow('check-in')">ðŸ“… Worker Check-In</button>
                <button onclick="showFlow('check-out')">ðŸ‘· Daily Scaffolding Report (Check-Out)</button>
                <button onclick="logout()">ðŸšª Logout</button>
            </div>

            <div id="check-in-flow" class="screen hidden">
                <h2>Worker Check-In</h2>
                <div id="checkin-error" class="error hidden"></div>

                <label for="checkin-project">Select Project</label>
                <select id="checkin-project" onchange="loadWorkers('checkin')"></select>

                <label for="checkin-worker">Select Worker</label>
                <select id="checkin-worker"></select>
                
                <label for="checkin-notes">Notes (Optional)</label>
                <input type="text" id="checkin-notes" placeholder="e.g., Late arrival">

                <button onclick="confirmSubmission('check-in')">Submit Check-In</button>
                <button class="btn" onclick="showFlow('main-menu')" style="background-color: #6c757d;">Cancel</button>
            </div>

            <div id="check-out-flow" class="screen hidden">
                <h2>Daily Scaffolding Report</h2>
                <div id="checkout-error" class="error hidden"></div>

                <label for="checkout-project">Select Project</label>
                <select id="checkout-project" onchange="loadWorkers('checkout'); loadAreas()"></select>
                
                <h3>Scaffolding Entries</h3>
                <div id="scaffolding-entries">
                    </div>
                <button onclick="addScaffoldingEntry()" style="background-color: #28a745;">+ Add Entry</button>
                
                <hr>
                
                <h3>Overtime Manpower</h3>
                <div id="ot-workers-container">
                    </div>
                <button onclick="addOtWorker()" style="background-color: #ffc107; color: #333;">+ Add OT Worker</button>

                <hr>

                <div id="summary-section">
                    <label for="checkout-notes">Report Notes (Optional)</label>
                    <input type="text" id="checkout-notes" placeholder="General daily report notes">
                </div>

                <button onclick="confirmSubmission('check-out')">Submit Daily Report</button>
                <button class="btn" onclick="showFlow('main-menu')" style="background-color: #6c757d;">Cancel</button>
            </div>

            <div id="confirmation-screen" class="screen hidden">
                <h2>Confirmation</h2>
                <div id="confirmation-details"></div>
                <button id="confirm-submit-btn" onclick="finalSubmit()">Confirm & Submit</button>
                <button class="btn" onclick="goBackToForm()" style="background-color: #dc3545;">Go Back & Edit</button>
            </div>

            <div id="success-screen" class="screen hidden">
                <h2>Submission Successful!</h2>
                <div id="success-message" class="success"></div>
                <h3>Generated Report</h3>
                <pre id="generated-report" style="white-space: pre-wrap; background-color: #eee; padding: 10px; border-radius: 4px;"></pre>
                
                <button onclick="copyReport()">ðŸ“‹ Copy Report</button>
                <button id="whatsapp-share-btn" class="hidden" onclick="shareToWhatsApp()">ðŸ“² Share to WhatsApp</button>
                
                <button class="btn" onclick="resetApp()">Start New Flow</button>
            </div>
            
            <div id="loading" class="hidden" style="text-align: center; padding: 20px;">
                <p>Processing request, please wait...</p>
            </div>
        </div>
    </div>

<script>
    // --- Global State ---
    const state = {
        supervisor: null,
        projects: [],
        workers: [],
        areas: [],
        currentFlow: null, // 'check-in' or 'check-out'
        failedLoginAttempts: 0,
        MAX_LOGIN_ATTEMPTS: 5,
    };

    // --- Utility Functions ---
    const getEl = id => document.getElementById(id);
    const show = id => getEl(id).classList.remove('hidden');
    const hide = id => getEl(id).classList.add('hidden');
    const setInner = (id, html) => getEl(id).innerHTML = html;
    
    function onServerFailure(error) {
        hide('loading');
        console.error('Apps Script Error:', error);
        const errorEl = state.currentFlow === 'check-in' ? getEl('checkin-error') : getEl('checkout-error');
        if (getEl('login-error').classList.contains('hidden')) {
             errorEl.innerText = 'Server Error: ' + error.message || 'An unknown error occurred.';
             show(errorEl.id);
        } else {
             getEl('login-error').innerText = 'Server Error: ' + error.message || 'An unknown error occurred.';
             show('login-error');
        }
    }
    
    // --- Core UI & Navigation ---
    function showFlow(flow) {
        state.currentFlow = flow;
        document.querySelectorAll('.screen').forEach(el => hide(el.id));
        hide('login-error'); hide('checkin-error'); hide('checkout-error');
        
        if (flow === 'check-in') {
            show('check-in-flow');
            populateProjects('checkin');
            loadWorkers('checkin');
        } else if (flow === 'check-out') {
            show('check-out-flow');
            populateProjects('checkout');
            loadWorkers('checkout');
            loadAreas();
            if (getEl('scaffolding-entries').children.length === 0) addScaffoldingEntry();
            if (getEl('ot-workers-container').children.length === 0) addOtWorker();
        } else if (flow === 'main-menu') {
            show('main-menu');
        } else if (flow === 'login-screen') {
            show('login-screen');
        } else if (flow === 'success-screen') {
            show('success-screen');
        } else if (flow === 'confirmation-screen') {
            show('confirmation-screen');
        }
    }
    
    function resetApp() {
        // Simple way to reset: reload the screen to the main menu
        getEl('scaffolding-entries').innerHTML = '';
        getEl('ot-workers-container').innerHTML = '';
        showFlow('main-menu');
    }

    // --- Authentication ---
    function handleLogin() {
        const username = getEl('username').value.trim();
        const passcode = getEl('passcode').value;
        hide('login-error');
        show('loading');

        if (!username || !passcode) {
            hide('loading');
            getEl('login-error').innerText = 'Please enter both username and passcode.';
            show('login-error');
            return;
        }

        google.script.run
            .withSuccessHandler(onLoginSuccess)
            .withFailureHandler(onServerFailure)
            .getSupervisor(username, passcode);
    }

    function onLoginSuccess(supervisor) {
        hide('loading');
        if (supervisor) {
            state.supervisor = supervisor;
            state.failedLoginAttempts = 0;
            
            getEl('supervisor-info').innerText = `Logged in as: ${supervisor.SupervisorName}`;
            setInner('welcome-message', `Welcome, ${supervisor.SupervisorName}!`);
            
            google.script.run
                .withSuccessHandler(onDataLoaded)
                .withFailureHandler(onServerFailure)
                .getDataForApp();
        } else {
            state.failedLoginAttempts++;
            getEl('login-error').innerText = 'Invalid username or passcode.';
            show('login-error');
            if (state.failedLoginAttempts >= state.MAX_LOGIN_ATTEMPTS) {
                getEl('login-error').innerText = 'Too many failed attempts. Please contact admin.';
                getEl('username').disabled = true;
                getEl('passcode').disabled = true;
                document.querySelector('#login-screen button').disabled = true;
            }
        }
    }
    
    function onDataLoaded(data) {
        state.projects = data.projects;
        state.workers = data.workers;
        state.areas = data.areas;
        showFlow('main-menu');
    }

    function logout() {
        state.supervisor = null;
        getEl('supervisor-info').innerText = '';
        getEl('username').value = '';
        getEl('passcode').value = '';
        showFlow('login-screen');
    }

    // --- Data Population ---
    function populateProjects(flowPrefix) {
        const select = getEl(`${flowPrefix}-project`);
        select.innerHTML = '<option value="">-- Select a Project --</option>';
        state.projects.forEach(p => {
            const option = document.createElement('option');
            option.value = p.ProjectID;
            option.text = `${p.ProjectName} (Shift: ${p.ShiftHours}h)`;
            option.dataset.shiftHours = p.ShiftHours;
            select.appendChild(option);
        });
        if (state.projects.length > 0) {
            select.value = state.projects[0].ProjectID;
        }
    }
    
    function loadWorkers(flowPrefix) {
        const projectId = getEl(`${flowPrefix}-project`).value;
        const workerSelect = getEl(`${flowPrefix}-worker`);
        if (workerSelect) {
             workerSelect.innerHTML = '<option value="">-- Select a Worker --</option>';
        }

        const workerSelects = document.querySelectorAll('.ot-worker-select');
        workerSelects.forEach(select => {
            const oldValue = select.value;
            select.innerHTML = '<option value="">-- Select OT Worker --</option>';
            const filteredWorkers = state.workers.filter(w => w.ProjectID === projectId);
            filteredWorkers.forEach(w => {
                const option = document.createElement('option');
                option.value = w.EmpCode;
                option.text = `${w.WorkerName} (${w.EmpCode})`;
                option.dataset.workerName = w.WorkerName;
                select.appendChild(option);
            });
            select.value = oldValue;
        });
        
        if (workerSelect) {
            const filteredWorkers = state.workers.filter(w => w.ProjectID === projectId);
            filteredWorkers.forEach(w => {
                const option = document.createElement('option');
                option.value = w.EmpCode;
                option.text = `${w.WorkerName} (${w.EmpCode})`;
                option.dataset.workerName = w.WorkerName;
                workerSelect.appendChild(option);
            });
        }
    }

    function loadAreas() {
        const projectId = getEl('checkout-project').value;
        document.querySelectorAll('.area-select').forEach(select => {
            const oldValue = select.value;
            select.innerHTML = '<option value="">-- Select Area --</option>';
            state.areas.filter(a => !a.ProjectID || a.ProjectID === projectId).forEach(a => {
                const option = document.createElement('option');
                option.value = a.AreaID;
                option.text = a.AreaName;
                option.dataset.areaName = a.AreaName;
                select.appendChild(option);
            });
            select.value = oldValue;
        });
    }

    // --- Check-Out Flow Helpers ---
    let entryCounter = 0;
    function addScaffoldingEntry(data = {}) {
        entryCounter++;
        const container = getEl('scaffolding-entries');
        const entryDiv = document.createElement('div');
        entryDiv.className = 'scaffolding-entry';
        entryDiv.dataset.id = entryCounter;
        
        entryDiv.innerHTML = `
            <h4>Entry #${entryCounter}</h4>
            <button class="remove-entry" onclick="removeScaffoldingEntry(${entryCounter})">Ã—</button>

            <label for="area-${entryCounter}">Area</label>
            <select id="area-${entryCounter}" class="area-select" data-field="AreaID" required></select>

            <label for="jobtype-${entryCounter}">Job Type</label>
            <select id="jobtype-${entryCounter}" data-field="JobType" required>
                <option value="">-- Select Type --</option>
                <option value="Erection">Erection</option>
                <option value="Dismantling">Dismantling</option>
            </select>

            <label for="l-${entryCounter}">Length (L in m)</label>
            <input type="number" id="l-${entryCounter}" data-field="L" step="0.01" min="0" value="${data.L || ''}" required>
            
            <label for="w-${entryCounter}">Width (W in m)</label>
            <input type="number" id="w-${entryCounter}" data-field="W" step="0.01" min="0" value="${data.W || ''}" required>

            <label for="h-${entryCounter}">Height (H in m)</label>
            <input type="number" id="h-${entryCounter}" data-field="H" step="0.01" min="0" value="${data.H || ''}" required>

            <label for="q-${entryCounter}">Quantity (Q)</label>
            <input type="number" id="q-${entryCounter}" data-field="Q" step="1" min="1" value="${data.Q || ''}" required>

            <label for="manpower-${entryCounter}">Manpower</label>
            <input type="number" id="manpower-${entryCounter}" data-field="Manpower" step="1" min="1" value="${data.Manpower || ''}" required>
            
            <label for="entry-notes-${entryCounter}">Notes (Optional)</label>
            <input type="text" id="entry-notes-${entryCounter}" data-field="Notes" value="${data.Notes || ''}">
        `;
        container.appendChild(entryDiv);
        loadAreas();
        
        if (data.AreaID) getEl(`area-${entryCounter}`).value = data.AreaID;
        if (data.JobType) getEl(`jobtype-${entryCounter}`).value = data.JobType;
    }

    function removeScaffoldingEntry(id) {
        const entryDiv = document.querySelector(`.scaffolding-entry[data-id="${id}"]`);
        if (entryDiv) {
            entryDiv.remove();
        }
    }
    
    let otCounter = 0;
    function addOtWorker(data = {}) {
        otCounter++;
        const container = getEl('ot-workers-container');
        const otDiv = document.createElement('div');
        otDiv.className = 'ot-worker-box';
        otDiv.dataset.id = otCounter;
        
        otDiv.innerHTML = `
            <select id="ot-worker-${otCounter}" class="ot-worker-select" data-field="EmpCode" required></select>
            <input type="number" id="ot-hours-${otCounter}" data-field="OT_Hours" placeholder="OT Hours" step="0.5" min="0.5" value="${data.OT_Hours || ''}" required>
            <button onclick="removeOtWorker(${otCounter})" style="background-color: #dc3545; width: 40px; padding: 0; margin: 0; flex-shrink: 0;">-</button>
        `;
        container.appendChild(otDiv);
        loadWorkers('checkout');
        
        if (data.EmpCode) getEl(`ot-worker-${otCounter}`).value = data.EmpCode;
    }
    
    function removeOtWorker(id) {
        const otDiv = document.querySelector(`.ot-worker-box[data-id="${id}"]`);
        if (otDiv) {
            otDiv.remove();
        }
    }


    // --- Submission Logic ---
    function validateForm(flow) {
        let isValid = true;
        let errorMsg = '';
        
        const projSelect = getEl(`${flow}-project`);
        if (!projSelect.value) {
            errorMsg += 'Please select a Project.\n';
            isValid = false;
        }

        if (flow === 'check-in') {
            if (!getEl('checkin-worker').value) {
                errorMsg += 'Please select a Worker.\n';
                isValid = false;
            }
        } else if (flow === 'check-out') {
            const entries = Array.from(document.querySelectorAll('.scaffolding-entry'));
            if (entries.length === 0) {
                errorMsg += 'Please add at least one Scaffolding Entry.\n';
                isValid = false;
            }
            
            entries.forEach((entry, index) => {
                const id = entry.dataset.id;
                const area = getEl(`area-${id}`).value;
                const jobType = getEl(`jobtype-${id}`).value;
                const L = parseFloat(getEl(`l-${id}`).value);
                const W = parseFloat(getEl(`w-${id}`).value);
                const H = parseFloat(getEl(`h-${id}`).value);
                const Q = parseInt(getEl(`q-${id}`).value);
                const Manpower = parseInt(getEl(`manpower-${id}`).value);

                if (!area || !jobType || isNaN(L) || L <= 0 || isNaN(W) || W <= 0 || isNaN(H) || H <= 0 || isNaN(Q) || Q < 1 || isNaN(Manpower) || Manpower < 1) {
                    errorMsg += `Entry #${index + 1}: Check all Area, Job Type, L, W, H (must be > 0), Q (must be >= 1) and Manpower (must be >= 1) fields.\n`;
                    isValid = false;
                }
            });
            
            const otEntries = Array.from(document.querySelectorAll('.ot-worker-box'));
            otEntries.forEach((otEntry, index) => {
                 const id = otEntry.dataset.id;
                 const empCode = getEl(`ot-worker-${id}`).value;
                 const otHours = parseFloat(getEl(`ot-hours-${id}`).value);
                 
                 if (!empCode || isNaN(otHours) || otHours <= 0) {
                     errorMsg += `OT Worker #${index + 1}: Select a Worker and enter valid OT Hours (must be > 0).\n`;
                     isValid = false;
                 }
            });
        }
        
        const errorEl = getEl(flow === 'check-in' ? 'checkin-error' : 'checkout-error');
        if (!isValid) {
            errorEl.innerText = errorMsg;
            show(errorEl.id);
        } else {
            hide(errorEl.id);
        }
        return isValid;
    }

    function preparePayload(flow) {
        const projectId = getEl(`${flow}-project`).value;
        const project = state.projects.find(p => p.ProjectID === projectId);
        
        const basePayload = {
            SupervisorUsername: state.supervisor.Username,
            SupervisorName: state.supervisor.SupervisorName,
            ProjectID: projectId,
            ProjectName: project ? project.ProjectName : 'Unknown',
            ShiftHours: project ? parseInt(project.ShiftHours) : 8,
        };
        
        if (flow === 'check-in') {
            const workerSelect = getEl('checkin-worker');
            const empCode = workerSelect.value;
            const workerName = workerSelect.options[workerSelect.selectedIndex].dataset.workerName || 'Unknown';
            
            return {
                ...basePayload,
                EmpCode: empCode,
                WorkerName: workerName,
                Notes: getEl('checkin-notes').value.trim(),
            };
        } else if (flow === 'check-out') {
            const entries = Array.from(document.querySelectorAll('.scaffolding-entry')).map(entry => {
                const id = entry.dataset.id;
                const areaSelect = getEl(`area-${id}`);
                return {
                    AreaID: areaSelect.value,
                    AreaName: areaSelect.options[areaSelect.selectedIndex].dataset.areaName || 'Unknown',
                    JobType: getEl(`jobtype-${id}`).value,
                    L: parseFloat(getEl(`l-${id}`).value),
                    W: parseFloat(getEl(`w-${id}`).value),
                    H: parseFloat(getEl(`h-${id}`).value),
                    Q: parseInt(getEl(`q-${id}`).value),
                    Manpower: parseInt(getEl(`manpower-${id}`).value),
                    Notes: getEl(`entry-notes-${id}`).value.trim(),
                };
            });
            
            const otWorkers = Array.from(document.querySelectorAll('.ot-worker-box')).map(otBox => {
                const id = otBox.dataset.id;
                const workerSelect = getEl(`ot-worker-${id}`);
                const empCode = workerSelect.value;
                const workerName = workerSelect.options[workerSelect.selectedIndex].dataset.workerName || 'Unknown';
                return {
                    EmpCode: empCode,
                    WorkerName: workerName,
                    OT_Hours: parseFloat(getEl(`ot-hours-${id}`).value),
                };
            });
            
            return {
                ...basePayload,
                Entries: entries,
                OTWorkers: otWorkers,
                ReportNotes: getEl('checkout-notes').value.trim(),
            };
        }
    }
    
    let currentPayload = null;

    function confirmSubmission(flow) {
        if (!validateForm(flow)) return;

        currentPayload = preparePayload(flow);
        const detailsEl = getEl('confirmation-details');
        
        let html = '';
        if (flow === 'check-in') {
            const workerSelect = getEl('checkin-worker');
            const workerName = workerSelect.options[workerSelect.selectedIndex].text;
            html = `
                <p><strong>Flow:</strong> Worker Check-In</p>
                <p><strong>Supervisor:</strong> ${currentPayload.SupervisorName}</p>
                <p><strong>Project:</strong> ${currentPayload.ProjectName}</p>
                <p><strong>Worker:</strong> ${workerName}</p>
                <p><strong>Notes:</strong> ${currentPayload.Notes || 'N/A'}</p>
            `;
        } else if (flow === 'check-out') {
            const totalManpower = currentPayload.Entries.reduce((sum, entry) => sum + entry.Manpower, 0);
            const totalOTHours = currentPayload.OTWorkers.reduce((sum, ot) => sum + ot.OT_Hours, 0);
            
            html = `
                <p><strong>Flow:</strong> Daily Scaffolding Report (Check-Out)</p>
                <p><strong>Supervisor:</strong> ${currentPayload.SupervisorName}</p>
                <p><strong>Project:</strong> ${currentPayload.ProjectName}</p>
                <p><strong>Total Scaffolding Entries:</strong> ${currentPayload.Entries.length}</p>
                <p><strong>Total Manpower (Day):</strong> ${totalManpower}</p>
                <p><strong>Total OT Hours:</strong> ${totalOTHours} hours</p>
                <p><strong>Report Notes:</strong> ${currentPayload.ReportNotes || 'N/A'}</p>
                
                <h4>Entries Summary:</h4>
                <ul style="list-style-type: none; padding-left: 0;">
                ${currentPayload.Entries.map((entry, i) => `
                    <li><strong>${i + 1}.</strong> ${entry.JobType} in ${entry.AreaName}: L${entry.L} x W${entry.W} x H${entry.H} x Q${entry.Q} (Manpower: ${entry.Manpower})</li>
                `).join('')}
                </ul>
            `;
        }
        
        detailsEl.innerHTML = html;
        getEl('confirm-submit-btn').dataset.flow = flow;
        showFlow('confirmation-screen');
    }
    
    function goBackToForm() {
        if (getEl('confirm-submit-btn').dataset.flow === 'check-in') {
            showFlow('check-in');
        } else {
            showFlow('check-out');
        }
    }

    function finalSubmit() {
        const flow = getEl('confirm-submit-btn').dataset.flow;
        hide('confirmation-screen');
        show('loading');

        if (flow === 'check-in') {
            google.script.run
                .withSuccessHandler(onSubmissionSuccess)
                .withFailureHandler(onServerFailure)
                .submitCheckIn(currentPayload);
        } else if (flow === 'check-out') {
            google.script.run
                .withSuccessHandler(onSubmissionSuccess)
                .withFailureHandler(onServerFailure)
                .submitCheckOut(currentPayload);
        }
    }
    
    function onSubmissionSuccess(result) {
        hide('loading');
        
        let message = '';
        if (getEl('confirm-submit-btn').dataset.flow === 'check-in') {
            message = `Worker ${result.WorkerName} (${result.EmpCode}) successfully checked in.`;
        } else {
            message = `Daily report for Project ${result.ProjectName} successfully submitted with ${result.TotalEntries} scaffolding entries.`;
        }

        getEl('success-message').innerText = message;
        getEl('generated-report').innerText = result.ReportText;
        getEl('whatsapp-share-btn').dataset.reportText = result.ReportText;
        
        if (navigator.share) {
             show('whatsapp-share-btn');
        } else {
             const isMobile = /Mobi|Android/i.test(navigator.userAgent);
             if (isMobile) {
                show('whatsapp-share-btn');
             } else {
                 hide('whatsapp-share-btn');
             }
        }
        
        showFlow('success-screen');
    }
    
    // --- Post-Submission Actions ---
    function copyReport() {
        const reportText = getEl('generated-report').innerText;
        navigator.clipboard.writeText(reportText).then(() => {
            alert('Report copied to clipboard!');
        }).catch(err => {
            console.error('Failed to copy text: ', err);
            alert('Could not copy report. Please copy manually.');
        });
    }

    function shareToWhatsApp() {
        const reportText = getEl('whatsapp-share-btn').dataset.reportText;
        const encodedText = encodeURIComponent(reportText);
        const url = `https://wa.me/?text=${encodedText}`;
        
        if (navigator.share) {
            navigator.share({
                title: 'Scaffolding Daily Report',
                text: reportText,
            }).catch(error => {
                if (error.name !== 'AbortError') {
                    console.error('Error sharing:', error);
                    window.open(url, '_blank');
                }
            });
        } else {
            window.open(url, '_blank');
        }
    }
    
    // --- App Initialization ---
    document.addEventListener('DOMContentLoaded', () => {
        showFlow('login-screen');
    });

</script>
</body>
</html>
