<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mobile Scaffolding Tracker</title>
  <style>
    :root{--accent:#0b7;--muted:#666}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;margin:0;padding:0;background:#f7f8fa;color:#111}
    header{background:#fff;padding:14px 16px;border-bottom:1px solid #e6e9ee;display:flex;align-items:center;gap:12px}
    header h1{font-size:16px;margin:0}
    .container{padding:12px;max-width:760px;margin:0 auto}
    .card{background:#fff;border-radius:8px;padding:12px;margin-bottom:12px;box-shadow:0 1px 0 rgba(0,0,0,0.04)}
    label{display:block;font-size:13px;margin-bottom:6px;color:#333}
    input[type="text"],input[type="password"],select,input[type="number"]{
      width:100%;padding:10px;border:1px solid #d6dbe6;border-radius:6px;font-size:15px;box-sizing:border-box
    }
    button{background:var(--accent);color:#002b; border:0;padding:10px 14px;border-radius:8px;font-size:15px;cursor:pointer}
    .muted{color:var(--muted);font-size:13px}
    .row{display:flex;gap:8px}
    .row .flex{flex:1}
    .link-btn{background:transparent;color:var(--accent);border:0;padding:8px;font-size:14px;cursor:pointer}
    .small{font-size:13px;padding:8px}
    .entry{border:1px dashed #e2e6ee;padding:8px;border-radius:8px;margin-bottom:8px}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    .error{color:#b00020}
    @media(min-width:600px){header h1{font-size:18px}}
  </style>
</head>
<body>
  <header>
    <h1 id="appTitle">Scaffold Tracker</h1>
    <div id="supervisorName" style="margin-left:auto;color:#555;font-size:13px"></div>
  </header>

  <div class="container">
    <div id="loginCard" class="card">
      <label for="usernameSelect">Supervisor</label>
      <select id="usernameSelect" aria-label="Supervisor username"></select>

      <label for="passcode">Passcode</label>
      <input id="passcode" type="password" inputmode="numeric" autocomplete="current-password" />

      <div style="margin-top:8px" class="actions">
        <button id="btnLogin">Login</button>
        <button id="btnInit" class="link-btn">Init Sheets (admin)</button>
        <button id="btnTestConnection" class="link-btn" title="Test the Web App connection">Test connection</button>
      </div>

      <div id="loginMsg" class="muted" style="margin-top:8px"></div>
      <div id="loginError" class="error" style="margin-top:8px;display:none"></div>
    </div>

    <div id="mainUI" style="display:none">
      <div class="card">
        <label for="projectSelect">Project</label>
        <select id="projectSelect"></select>
      </div>

      <div class="card">
        <div style="display:flex;gap:8px">
          <button id="showCheckIn" class="small">Check-In</button>
          <button id="showCheckOut" class="small">Check-Out</button>
        </div>
      </div>

      <div id="checkInCard" class="card" style="display:none">
        <h3>Check-In</h3>
        <label for="workerSelect">Worker</label>
        <select id="workerSelect"></select>
        <label for="checkinNotes">Notes (optional)</label>
        <input id="checkinNotes" type="text" />
        <div style="margin-top:8px" class="actions">
          <button id="submitCheckIn">Submit Check-In</button>
        </div>
      </div>

      <div id="checkOutCard" class="card" style="display:none">
        <h3>Check-Out / Scaffolding Entries</h3>
        <div id="entries"></div>
        <div style="margin-top:8px" class="actions">
          <button id="addEntry" class="small">Add Entry</button>
          <button id="submitCheckOut" class="small">Submit All</button>
        </div>
        <div id="totals" class="muted" style="margin-top:8px"></div>
      </div>

      <div id="confirmCard" class="card" style="display:none">
        <h3>Report</h3>
        <pre id="reportText" style="white-space:pre-wrap"></pre>
        <div class="actions" style="margin-top:8px">
          <button id="copyReport" class="small">Copy Report</button>
          <button id="shareWhatsApp" class="small">Share to WhatsApp</button>
          <button id="done" class="small">Done</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // CONFIG: replace with your deployed Apps Script web app URL if hosting on GitHub Pages
    const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzvVEu0jcARC0gWdY-Gy4w-HFo5h-tZ3bbKK2q3OP9hkTDTrbX87bucKfO-grBT3ws/exec'; // e.g. https://script.google.com/macros/s/AKfy.../exec

    // Helper: call backend via google.script.run (if available) or fetch to web app
    function apiCall(action, payload = {}) {
      payload.action = action;
      // If running inside Apps Script HTML sandbox:
      if (window.google && google.script && google.script.run) {
        return new Promise((resolve, reject) => {
          google.script.run.withSuccessHandler(resolve).withFailureHandler(err => reject(err)).apiProxy(payload);
        });
      } else {
        if (!WEB_APP_URL || WEB_APP_URL.startsWith('REPLACE_WITH')) {
          return Promise.reject('No web app URL configured. Set WEB_APP_URL in index.html or serve this file from Apps Script.');
        }
        return fetch(WEB_APP_URL, {
          method: 'POST',
          mode: 'cors',
          credentials: 'omit',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        }).then(async r => {
          if (!r.ok) {
            // try to get text for debugging
            const text = await r.text().catch(()=>'<no body>');
            throw new Error(`HTTP ${r.status} ${r.statusText}: ${text}`);
          }
          return r.json();
        }).catch(err => {
          // Wrap to provide clearer guidance for users
          const help = `Network error contacting web app: ${err.message || err}. Possible causes:\n- Web app not deployed for "Anyone, even anonymous"\n- Using the wrong exec URL\n- CORS / authentication blocked\nClick "Test connection" for a quick check.`;
          const e = new Error(help);
          e.original = err;
          throw e;
        });
      }
    }

    // UI state
    let currentSupervisor = null;
    let projects = [];
    let workers = {};
    let otWorkersCache = {};
    let MAX_OT_BOXES = 5;
    let supervisors = [];

    // Elements
    const loginCard = document.getElementById('loginCard');
    const mainUI = document.getElementById('mainUI');
    const usernameSelect = document.getElementById('usernameSelect');
    const passcodeEl = document.getElementById('passcode');
    const btnLogin = document.getElementById('btnLogin');
    const btnInit = document.getElementById('btnInit');
    const btnTestConnection = document.getElementById('btnTestConnection');
    const loginMsg = document.getElementById('loginMsg');
    const loginError = document.getElementById('loginError');
    const supervisorNameEl = document.getElementById('supervisorName');
    const projectSelect = document.getElementById('projectSelect');
    const workerSelect = document.getElementById('workerSelect');
    const showCheckIn = document.getElementById('showCheckIn');
    const showCheckOut = document.getElementById('showCheckOut');
    const checkInCard = document.getElementById('checkInCard');
    const checkOutCard = document.getElementById('checkOutCard');
    const submitCheckInBtn = document.getElementById('submitCheckIn');
    const checkinNotes = document.getElementById('checkinNotes');
    const entriesDiv = document.getElementById('entries');
    const addEntryBtn = document.getElementById('addEntry');
    const submitCheckOutBtn = document.getElementById('submitCheckOut');
    const totalsDiv = document.getElementById('totals');
    const confirmCard = document.getElementById('confirmCard');
    const reportTextEl = document.getElementById('reportText');
    const copyReportBtn = document.getElementById('copyReport');
    const shareWhatsAppBtn = document.getElementById('shareWhatsApp');
    const doneBtn = document.getElementById('done');

    // Initialize UI
    document.addEventListener('DOMContentLoaded', initUI);

    function initUI() {
      loginMsg.textContent = 'Loading supervisors...';
      // Load supervisors first, then projects as needed
      apiCall('getSupervisors').then(res => {
        if (res && res.ok) {
          supervisors = res.supervisors || [];
          renderSupervisors(supervisors);
          loginMsg.textContent = '';
        } else {
          loginMsg.textContent = '';
          showLoginError(res && res.error ? res.error : 'Failed to load supervisors');
        }
      }).catch(err => {
        loginMsg.textContent = '';
        showLoginError(err.message || String(err));
      });

      // Attempt to preload projects too for faster UX
      apiCall('getProjects').then(res => {
        if (res && res.ok) {
          projects = res.projects || [];
          renderProjects();
        }
      }).catch(()=>{ /* ignore early project load failures */ });

      btnInit.addEventListener('click', () => {
        setButtonBusy(btnInit, true, 'Initializing...');
        apiCall('initSheets', {}).then(res => {
          alert('initSheets completed: ' + (res && res.ok ? 'OK' : JSON.stringify(res)));
        }).catch(e => alert('init failed: ' + e.message || e)).finally(()=>setButtonBusy(btnInit,false,'Init Sheets (admin)'));
      });

      btnTestConnection.addEventListener('click', testConnection);

      btnLogin.addEventListener('click', () => {
        loginError.style.display = 'none';
        const sel = usernameSelect.value;
        const pass = passcodeEl.value.trim();
        if (!sel) return showLoginError('Select a supervisor username from the dropdown.');
        if (!pass) return showLoginError('Enter passcode.');
        const sup = supervisors.find(s => String(s.Username)===String(sel));
        if (!sup) return showLoginError('Selected supervisor not found.');
        loginMsg.textContent = 'Verifying...';
        apiCall('verifyLogin', {username: sel, passcode: pass}).then(res => {
          loginMsg.textContent = '';
          if (res && res.ok && res.supervisor) {
            currentSupervisor = res.supervisor;
            afterLogin();
          } else {
            showLoginError(res && res.error ? res.error : 'Invalid credentials');
          }
        }).catch(err => {
          loginMsg.textContent = '';
          showLoginError(err.message || String(err));
        });
      });

      showCheckIn.addEventListener('click', () => {
        checkInCard.style.display = '';
        checkOutCard.style.display = 'none';
      });
      showCheckOut.addEventListener('click', () => {
        checkInCard.style.display = 'none';
        checkOutCard.style.display = '';
      });

      submitCheckInBtn.addEventListener('click', () => {
        if (!currentSupervisor) return showLoginError('Not logged in.');
        const pid = projectSelect.value; if (!pid) return alert('Select project');
        const empCode = workerSelect.value; if (!empCode) return alert('Select worker');
        const workerText = workerSelect.selectedOptions[0].textContent;
        const payload = {
          supervisorUsername: currentSupervisor.Username,
          supervisorName: currentSupervisor.SupervisorName,
          projectId: pid,
          projectName: (projects.find(p=>p.ProjectID===pid)||{}).ProjectName || '',
          empCode,
          workerName: workerText.replace(/\s*\(.+$/,''),
          notes: checkinNotes.value || ''
        };
        submitCheckInBtn.disabled = true;
        apiCall('submitCheckIn', {payload}).then(res => {
          submitCheckInBtn.disabled = false;
          if (res && res.ok) {
            showReport(res.reportText);
          } else {
            alert('Error: ' + (res.error || JSON.stringify(res)));
          }
        }).catch(err => { submitCheckInBtn.disabled=false; alert('Error: ' + (err.message || err)); });
      });

      addEntryBtn.addEventListener('click', () => addEntryUI());
      submitCheckOutBtn.addEventListener('click', submitCheckOutHandler);
    }

    function renderSupervisors(list) {
      usernameSelect.innerHTML = '';
      const opt = document.createElement('option'); opt.value=''; opt.textContent='-- Select Supervisor --'; usernameSelect.appendChild(opt);
      list.forEach(s => {
        const o = document.createElement('option'); o.value = s.Username; o.textContent = `${s.SupervisorName || s.Username} (${s.Username})`; usernameSelect.appendChild(o);
      });
    }

    function showLoginError(msg) {
      loginError.style.display = '';
      loginError.textContent = msg;
    }

    function setButtonBusy(btn, busy, text) {
      btn.disabled = busy;
      if (text) btn.textContent = text;
    }

    function afterLogin() {
      loginCard.style.display = 'none';
      mainUI.style.display = '';
      supervisorNameEl.textContent = currentSupervisor.SupervisorName || currentSupervisor.Username;
      // Load projects & workers for selected project on change
      apiCall('getProjects').then(res => {
        if (res && res.ok) {
          projects = res.projects || [];
          renderProjects();
        }
      }).catch(e => console.warn(e));
    }

    function renderProjects() {
      projectSelect.innerHTML = '';
      const opt = document.createElement('option'); opt.value=''; opt.textContent='-- Select Project --'; projectSelect.appendChild(opt);
      projects.forEach(p => {
        const o = document.createElement('option'); o.value = p.ProjectID; o.textContent = `${p.ProjectName} (${p.ProjectID})`; projectSelect.appendChild(o);
      });
      projectSelect.addEventListener('change', () => {
        const pid = projectSelect.value;
        if (!pid) return;
        apiCall('getWorkers', {projectId: pid}).then(res => {
          if (res && res.ok) renderWorkers(res.workers || []);
        }).catch(e => console.warn(e));
        apiCall('getOTWorkers', {projectId: pid}).then(res => {
          if (res && res.ok) otWorkersCache[pid]=res.otWorkers||[];
        }).catch(()=>{});
      });
    }

    function renderWorkers(list) {
      workerSelect.innerHTML = '';
      const opt = document.createElement('option'); opt.value=''; opt.textContent='-- Select Worker --'; workerSelect.appendChild(opt);
      list.forEach(w => {
        const o = document.createElement('option'); o.value = w.EmpCode; o.textContent = `${w.WorkerName} (${w.EmpCode})`; workerSelect.appendChild(o);
      });
    }

    // Check-out UI builders (same as before, omitted some comments)
    function addEntryUI(existing) {
      const idx = document.querySelectorAll('.entry').length;
      const wrapper = document.createElement('div'); wrapper.className='entry';
      wrapper.innerHTML = `
        <div class="row">
          <div class="flex"><label>Area</label><select class="areaSelect"></select></div>
          <div style="width:110px"><label>Job</label><select class="jobType"><option value="Erection">Erection</option><option value="Dismantling">Dismantling</option></select></div>
        </div>
        <div class="row" style="margin-top:8px">
          <div class="flex"><label>L (m)</label><input class="L" type="number" step="0.01" /></div>
          <div class="flex"><label>W (m)</label><input class="W" type="number" step="0.01" /></div>
          <div class="flex"><label>H (m)</label><input class="H" type="number" step="0.01" /></div>
        </div>
        <div class="row" style="margin-top:8px">
          <div style="width:120px"><label>Q</label><input class="Q" type="number" step="1" min="1" value="1" /></div>
          <div style="width:120px"><label>Manpower</label><input class="manpower" type="number" step="1" min="0" value="1" /></div>
          <div class="flex"><label>OT Hours (optional)</label><input class="otHours" type="number" step="0.1" min="0" /></div>
        </div>
        <div style="margin-top:8px"><label>Workers OT</label><div class="otBoxes"></div></div>
        <div style="margin-top:8px" class="actions"><button class="removeEntry small">Remove</button></div>
      `;
      entriesDiv.appendChild(wrapper);

      const pid = projectSelect.value;
      apiCall('getAreas', {projectId: pid}).then(res => {
        const sel = wrapper.querySelector('.areaSelect');
        sel.innerHTML = '';
        const o0 = document.createElement('option'); o0.value=''; o0.textContent='-- Area --'; sel.appendChild(o0);
        if (res && res.ok) {
          (res.areas || []).forEach(a => {
            const o = document.createElement('option'); o.value = a.AreaID; o.textContent = a.AreaName + (a.ProjectID ? ' ('+a.ProjectID+')' : ''); sel.appendChild(o);
          });
        }
      }).catch(()=>{});

      const otBoxes = wrapper.querySelector('.otBoxes');
      const otList = otWorkersCache[pid] && otWorkersCache[pid].length ? otWorkersCache[pid] : [];
      // default MAX_OT_BOXES or fallback
      const boxes = MAX_OT_BOXES || 5;
      for (let i=0;i<boxes;i++) {
        const sel = document.createElement('select'); sel.className='otSelect'; sel.style.marginRight='6px'; sel.style.marginTop='6px';
        const o0 = document.createElement('option'); o0.value=''; o0.textContent='--'; sel.appendChild(o0);
        if (otList.length) {
          otList.forEach(w => {
            const o = document.createElement('option'); o.value = w.EmpCode; o.textContent = `${w.WorkerName} (${w.EmpCode})`; sel.appendChild(o);
          });
        } else {
          Array.from(workerSelect.options).slice(1).forEach(opt => {
            const o = document.createElement('option'); o.value = opt.value; o.textContent = opt.textContent; sel.appendChild(o);
          });
        }
        otBoxes.appendChild(sel);
      }

      wrapper.querySelector('.removeEntry').addEventListener('click', () => { wrapper.remove(); computeTotals(); });
      wrapper.addEventListener('input', computeTotals);
      computeTotals();
    }

    function computeTotals() {
      let totalE=0,totalD=0,totalMan=0,totalOT=0;
      document.querySelectorAll('.entry').forEach(e => {
        const jobType = e.querySelector('.jobType').value;
        const L = parseFloat(e.querySelector('.L').value||0);
        const W = parseFloat(e.querySelector('.W').value||0);
        const H = parseFloat(e.querySelector('.H').value||0);
        const Q = parseInt(e.querySelector('.Q').value||0);
        const manpower = parseInt(e.querySelector('.manpower').value||0);
        const otHours = parseFloat(e.querySelector('.otHours').value||0);
        const vol = (jobType === 'Erection') ? (L*W*H*Q) : ((L*W*H*Q)/2);
        if (jobType === 'Erection') totalE += vol; else totalD += vol;
        totalMan += manpower;
        totalOT += isNaN(otHours)?0:otHours;
      });
      totalsDiv.textContent = `Totals — Erection: ${totalE.toFixed(2)}, Dismantling: ${totalD.toFixed(2)}, Manpower: ${totalMan}, OT Hours: ${totalOT.toFixed(1)}`;
    }

    function submitCheckOutHandler() {
      if (!currentSupervisor) return showLoginError('Not logged in.');
      const pid = projectSelect.value; if (!pid) return alert('Select project');
      const entries = [];
      const projectName = (projects.find(p=>p.ProjectID===pid)||{}).ProjectName || '';
      document.querySelectorAll('.entry').forEach(e => {
        const areaId = e.querySelector('.areaSelect').value;
        const areaName = e.querySelector('.areaSelect').selectedOptions[0] ? e.querySelector('.areaSelect').selectedOptions[0].textContent.replace(/\s*\(.+$/,'') : '';
        const jobType = e.querySelector('.jobType').value;
        const L = parseFloat(e.querySelector('.L').value||0);
        const W = parseFloat(e.querySelector('.W').value||0);
        const H = parseFloat(e.querySelector('.H').value||0);
        const Q = parseInt(e.querySelector('.Q').value||1,10);
        const manpower = parseInt(e.querySelector('.manpower').value||0,10);
        const otHours = parseFloat(e.querySelector('.otHours').value||0);
        const otSelected = Array.from(e.querySelectorAll('.otSelect')).map(s=>s.value).filter(Boolean);
        entries.push({areaId, areaName, jobType, L, W, H, Q, manpower, otHours, otSelected});
      });
      if (!entries.length) return alert('Add at least one entry');
      const payload = {
        supervisorUsername: currentSupervisor.Username,
        supervisorName: currentSupervisor.SupervisorName,
        projectId: pid,
        projectName,
        entries
      };
      submitCheckOutBtn.disabled = true;
      apiCall('submitCheckOut', {payload}).then(res => {
        submitCheckOutBtn.disabled = false;
        if (res && res.ok) {
          showReport(res.reportText);
        } else {
          alert('Error: ' + (res.error || JSON.stringify(res)));
        }
      }).catch(err => { submitCheckOutBtn.disabled=false; alert('Error: ' + (err.message || err)); });
    }

    function showReport(text) {
      reportTextEl.textContent = text;
      confirmCard.style.display = '';
      copyReportBtn.onclick = async () => {
        try { await navigator.clipboard.writeText(text); alert('Copied'); } catch(e) { alert('Copy failed: ' + e); }
      };
      shareWhatsAppBtn.onclick = () => {
        const url = 'https://wa.me/?text=' + encodeURIComponent(text);
        window.open(url,'_blank');
      };
      doneBtn.onclick = () => {
        confirmCard.style.display='none';
        checkinNotes.value=''; entriesDiv.innerHTML=''; computeTotals();
      };
    }

    // Connection test helper - attempts a lightweight fetch to the web app URL
    function testConnection() {
      loginError.style.display = 'none';
      if (window.google && google.script && google.script.run) {
        alert('This page is running inside Apps Script (google.script.run available). No cross-origin fetch needed.');
        return;
      }
      if (!WEB_APP_URL || WEB_APP_URL.startsWith('REPLACE_WITH')) {
        showLoginError('WEB_APP_URL is not configured in index.html. Set the deployed web app exec URL in the WEB_APP_URL constant.');
        return;
      }
      // Try POST with a simple action that doesn't change data
      fetch(WEB_APP_URL, {
        method: 'POST',
        mode: 'cors',
        credentials: 'omit',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({action:'getConfig'})
      }).then(async r => {
        if (!r.ok) {
          const txt = await r.text().catch(()=>'<no body>');
          showLoginError(`Connection test failed: HTTP ${r.status} ${r.statusText}\n${txt}\n\nMake sure web app is deployed "Anyone, even anonymous" or accessible to your users.`);
        } else {
          const body = await r.json().catch(()=>null);
          if (body && body.ok) {
            alert('Connection test OK — web app reachable.');
            // Optionally reload supervisors/projects
            initUI();
          } else {
            showLoginError('Connection succeeded but response not OK: ' + JSON.stringify(body));
          }
        }
      }).catch(err => {
        showLoginError('Connection test error: ' + (err.message || err) + '\n\nLikely causes:\n- Web app requires login (not "Anyone, even anonymous")\n- Wrong exec URL\n- Network / ad-blocker / corporate proxy blocking the request\nUse the Apps Script editor to confirm deployment settings, then redeploy and update WEB_APP_URL.');
      });
    }
  </script>
</body>
</html>
