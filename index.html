<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Worker Attendance App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; margin: 0 auto;}
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        input, select, button { touch-action: manipulation; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen text-gray-800 font-sans">

    <script>
        // !!! REPLACE THIS PLACEHOLDER with your actual Google Apps Script Web App URL !!!
        const SCRIPT_URL = "YOUR_GOOGLE_SCRIPT_WEB_APP_URL_HERE"; 
        // -----------------------------------------------------------------------------
    </script>

    <div class="max-w-md mx-auto bg-white min-h-screen shadow-xl relative pb-10">
        
        <div class="bg-blue-800 text-white p-4 flex justify-between items-center shadow-md">
            <h1 class="font-bold text-lg"><i class="fas fa-hard-hat mr-2"></i>Site Tracker</h1>
            <button id="logout-btn" onclick="logout()" class="hidden text-xs bg-blue-900 px-3 py-1 rounded border border-blue-700">LOGOUT</button>
        </div>

        <div id="notification" class="hidden fixed top-20 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white text-sm px-4 py-3 rounded shadow-lg z-50 text-center w-3/4 transition-opacity duration-300"></div>

        <div id="view-login" class="p-8 flex flex-col justify-center h-[80vh]">
            <h2 class="text-2xl font-bold mb-2 text-center text-gray-700">Supervisor Login</h2>
            <p class="text-center text-gray-400 text-sm mb-8">Enter your credentials to continue</p>
            
            <div class="space-y-4">
                <div>
                    <label class="text-xs font-bold text-gray-600 uppercase">Username</label>
                    <input type="text" id="login-user" class="w-full p-3 border border-gray-300 rounded focus:border-blue-500 focus:outline-none" placeholder="e.g. admin">
                </div>
                <div>
                    <label class="text-xs font-bold text-gray-600 uppercase">Password</label>
                    <input type="password" id="login-pass" class="w-full p-3 border border-gray-300 rounded focus:border-blue-500 focus:outline-none" placeholder="e.g. 1234">
                </div>
                <button onclick="login()" class="w-full bg-blue-600 text-white p-4 rounded font-bold hover:bg-blue-700 transition shadow-lg mt-4">LOGIN</button>
            </div>
            <div id="login-loader" class="loader hidden mt-6"></div>
            
            <div class="mt-8 text-center text-xs text-gray-400">
                <p>Sample Login: admin / 1234</p>
            </div>
        </div>

        <div id="view-dashboard" class="hidden p-6">
            <div class="mb-6">
                <h2 class="text-xl font-bold text-gray-700">Hello, <span id="dash-user" class="text-blue-600"></span></h2>
                <p class="text-sm text-gray-500">What would you like to do today?</p>
            </div>

            <div class="grid grid-cols-1 gap-4">
                <button onclick="showCheckIn()" class="bg-gradient-to-r from-green-500 to-green-600 text-white p-6 rounded-xl shadow-lg hover:from-green-600 hover:to-green-700 transition flex items-center justify-between">
                    <div class="text-left">
                        <div class="font-bold text-lg">Check IN</div>
                        <div class="text-xs opacity-90">Morning Attendance</div>
                    </div>
                    <i class="fas fa-user-check text-3xl opacity-50"></i>
                </button>

                <button onclick="showCheckOut()" class="bg-gradient-to-r from-orange-500 to-orange-600 text-white p-6 rounded-xl shadow-lg hover:from-orange-600 hover:to-orange-700 transition flex items-center justify-between">
                    <div class="text-left">
                        <div class="font-bold text-lg">Check OUT</div>
                        <div class="text-xs opacity-90">Daily Report & Measurements</div>
                    </div>
                    <i class="fas fa-clipboard-list text-3xl opacity-50"></i>
                </button>
            </div>
            
            <div id="data-loader" class="loader mt-10"></div>
            <p id="data-status" class="text-center text-gray-400 mt-2 text-xs">Syncing project data...</p>
        </div>

        <div id="view-checkin" class="hidden p-4">
            <button onclick="showDashboard()" class="mb-4 text-gray-500 text-sm font-bold flex items-center"><i class="fas fa-arrow-left mr-2"></i> Dashboard</button>
            <div class="bg-white rounded-lg p-1">
                <h2 class="text-lg font-bold mb-4 text-green-700 border-b pb-2">Check-In Form</h2>
                
                <label class="block text-xs font-bold text-gray-600 mb-1">PROJECT</label>
                <select id="ci-project" onchange="renderWorkers('ci')" class="w-full p-3 border rounded mb-4 bg-gray-50 font-semibold"></select>

                <label class="block text-xs font-bold text-gray-600 mb-1">SELECT WORKERS</label>
                <div id="ci-worker-list" class="h-64 overflow-y-auto border rounded p-2 bg-gray-50 mb-4 space-y-2"></div>

                <button onclick="submitCheckIn()" class="w-full bg-green-600 text-white p-3 rounded font-bold shadow-lg">SUBMIT CHECK-IN</button>
                <div id="ci-loader" class="loader hidden mt-4"></div>
            </div>
        </div>

        <div id="view-checkout" class="hidden p-4 pb-20">
            <button onclick="showDashboard()" class="mb-4 text-gray-500 text-sm font-bold flex items-center"><i class="fas fa-arrow-left mr-2"></i> Dashboard</button>
            <div class="bg-white rounded-lg p-1">
                <h2 class="text-lg font-bold mb-4 text-orange-700 border-b pb-2">Check-Out & Report</h2>

                <label class="block text-xs font-bold text-gray-600 mb-1">PROJECT</label>
                <select id="co-project" onchange="handleProjectChange()" class="w-full p-3 border rounded mb-4 bg-gray-50 font-semibold"></select>

                <div class="bg-gray-50 p-2 rounded border mb-4">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="font-bold text-gray-700 text-sm">Measurements</h3>
                        <button onclick="addMeasurementRow()" class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded font-bold">+ ADD ROW</button>
                    </div>
                    <div id="measurement-container" class="space-y-2"></div>
                </div>

                <div class="grid grid-cols-2 gap-3 mb-4">
                    <div>
                        <label class="block text-[10px] font-bold text-gray-500 uppercase">Total Manpower</label>
                        <input type="number" id="co-manpower" oninput="calculateTotals()" class="w-full p-2 border rounded text-center font-bold text-lg" placeholder="0">
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-gray-500 uppercase">Select OT Staff</label>
                        <button onclick="document.getElementById('ot-modal').classList.remove('hidden')" class="w-full p-2 border rounded bg-blue-50 text-blue-600 text-xs font-bold h-[46px] truncate">Select List...</button>
                    </div>
                </div>

                <div class="bg-gray-800 text-white p-4 rounded-lg mb-4 text-sm shadow-lg">
                    <div class="flex justify-between mb-1"><span>Tot. Erection:</span> <span id="disp-erection" class="font-mono text-green-400">0.00</span></div>
                    <div class="flex justify-between mb-1"><span>Tot. Dismantling:</span> <span id="disp-dismantling" class="font-mono text-orange-400">0.00</span></div>
                    <div class="border-t border-gray-600 my-2"></div>
                    <div class="flex justify-between mb-1"><span>Total Manhours:</span> <span id="disp-manhours" class="font-mono font-bold">0</span></div>
                    <div class="flex justify-between"><span>Productivity:</span> <span id="disp-prod" class="font-mono font-bold text-blue-300">0.00</span></div>
                </div>

                <button onclick="submitCheckOut()" class="w-full bg-orange-600 text-white p-3 rounded font-bold shadow-lg">SUBMIT REPORT</button>
                <div id="co-loader" class="loader hidden mt-4"></div>
            </div>
        </div>

        <div id="ot-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50">
            <div class="bg-white p-4 rounded-lg w-11/12 max-w-sm max-h-[70vh] flex flex-col">
                <h3 class="font-bold mb-2 text-gray-700">Select Workers in OT</h3>
                <div id="ot-worker-list" class="overflow-y-auto flex-1 border p-2 mb-2 bg-gray-50 rounded"></div>
                <button onclick="document.getElementById('ot-modal').classList.add('hidden'); calculateTotals();" class="bg-blue-600 text-white p-2 rounded font-bold">DONE</button>
            </div>
        </div>

        <div id="report-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50">
            <div class="bg-white p-5 rounded-lg w-11/12 max-w-sm shadow-2xl">
                <div class="text-center mb-3">
                    <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100">
                        <i class="fas fa-check text-green-600 text-xl"></i>
                    </div>
                    <h3 class="text-lg font-bold text-gray-900 mt-2">Report Generated!</h3>
                </div>
                <textarea id="report-text" class="w-full h-32 p-2 border text-xs bg-gray-50 rounded mb-4 font-mono" readonly></textarea>
                <div class="flex gap-2">
                    <button onclick="copyReport()" class="flex-1 bg-gray-200 p-2 rounded text-gray-700 font-bold text-sm">Copy</button>
                    <button onclick="shareWhatsapp()" class="flex-1 bg-green-500 text-white p-2 rounded font-bold text-sm"><i class="fab fa-whatsapp"></i> WhatsApp</button>
                </div>
                <button onclick="closeReport()" class="w-full mt-4 text-gray-400 text-xs">Close Window</button>
            </div>
        </div>
    </div>

    <script>
        // --- GLOBAL STATE ---
        let appData = { projects: [], workers: [], areas: [] };
        let currentUser = "";
        let currentShiftHours = 8;

        // --- NAVIGATION ---
        function notify(msg) {
            const n = document.getElementById('notification');
            n.innerText = msg; n.classList.remove('hidden');
            setTimeout(() => n.classList.add('hidden'), 3000);
        }

        function switchView(id) {
            ['view-login', 'view-dashboard', 'view-checkin', 'view-checkout'].forEach(v => document.getElementById(v).classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
            window.scrollTo(0,0);
        }
        
        function showDashboard() { switchView('view-dashboard'); document.getElementById('logout-btn').classList.remove('hidden'); }
        function showCheckIn() { renderWorkers('ci'); switchView('view-checkin'); }
        function showCheckOut() { 
            document.getElementById('measurement-container').innerHTML = ''; 
            addMeasurementRow(); 
            handleProjectChange();
            switchView('view-checkout'); 
        }

        // --- API HANDLER ---
        async function postData(data) {
            const response = await fetch(SCRIPT_URL, {
                method: "POST",
                body: JSON.stringify(data)
            });
            return await response.json();
        }

        // --- LOGIN & LOAD ---
        async function login() {
            const u = document.getElementById('login-user').value;
            const p = document.getElementById('login-pass').value;
            if(!u || !p) return notify("Enter details");
            document.getElementById('login-loader').classList.remove('hidden');
            try {
                const res = await postData({ action: "login", username: u, password: p });
                if (res.status === "success") {
                    currentUser = res.username;
                    document.getElementById('dash-user').innerText = currentUser;
                    showDashboard();
                    loadData();
                } else notify(res.message);
            } catch (e) { notify("Connection Error"); }
            document.getElementById('login-loader').classList.add('hidden');
        }

        function logout() { location.reload(); }

        async function loadData() {
            try {
                const res = await postData({ action: "getData" });
                appData = res;
                document.getElementById('data-status').innerText = "Data Synced";
                document.getElementById('data-loader').classList.add('hidden');
                
                const populate = (id) => {
                    const sel = document.getElementById(id);
                    sel.innerHTML = "";
                    appData.projects.forEach(p => {
                        let opt = document.createElement('option');
                        opt.value = p.name; opt.innerText = p.name; opt.dataset.shift = p.shift;
                        sel.appendChild(opt);
                    });
                };
                populate('ci-project');
                populate('co-project');
            } catch (e) { notify("Failed to load data"); }
        }

        // --- WORKER RENDERER ---
        function renderWorkers(mode) {
            const projSelect = document.getElementById(mode + '-project');
            const pid = projSelect.value;
            const container = document.getElementById(mode + '-worker-list');
            container.innerHTML = "";
            
            const filtered = appData.workers.filter(w => w.project === pid);
            if (filtered.length === 0) {
                container.innerHTML = "<div class='p-2 text-gray-400'>No workers found</div>";
                return;
            }

            filtered.forEach(w => {
                const label = document.createElement('label');
                label.className = "flex items-center gap-3 p-3 border-b bg-white";
                label.innerHTML = `
                    <input type="checkbox" value="${w.code}" data-name="${w.name}" class="w-5 h-5">
                    <div><div class="font-bold text-sm">${w.name}</div><div class="text-xs text-gray-500">${w.code}</div></div>
                `;
                container.appendChild(label);
            });
        }

        function handleProjectChange() {
            const sel = document.getElementById('co-project');
            const selectedOpt = sel.options[sel.selectedIndex];
            currentShiftHours = selectedOpt ? parseInt(selectedOpt.dataset.shift) || 8 : 8;
            renderWorkers('ot'); 
            calculateTotals();
        }

        // --- CHECK IN SUBMIT ---
        async function submitCheckIn() {
            const proj = document.getElementById('ci-project').value;
            const checks = document.querySelectorAll('#ci-worker-list input:checked');
            if (checks.length === 0) { notify("Select workers"); return; }
            
            const selectedWorkers = Array.from(checks).map(c => ({ name: c.dataset.name, code: c.value }));
            document.getElementById('ci-loader').classList.remove('hidden');
            
            try {
                await postData({ action: "submitCheckIn", supervisor: currentUser, project: proj, workers: selectedWorkers });
                const date = new Date().toLocaleDateString();
                let txt = `‚úÖ *CHECK-IN*\nüìÖ ${date}\nüë∑ Sup: ${currentUser}\nüèóÔ∏è Proj: ${proj}\nüë• Count: ${selectedWorkers.length}`;
                showReport(txt);
            } catch(e) { notify("Error"); }
            document.getElementById('ci-loader').classList.add('hidden');
        }

        // --- CHECK OUT: MEASUREMENTS ---
        function addMeasurementRow() {
            const div = document.createElement('div');
            div.className = "measurement-row bg-white p-2 rounded shadow border mb-2";
            let areaOpts = appData.areas.map(a => `<option value="${a}">${a}</option>`).join('');

            div.innerHTML = `
                <div class="flex justify-between mb-2">
                    <select class="text-xs border p-1 w-1/2 mr-1 area-val bg-gray-50">${areaOpts}</select>
                    <select class="text-xs border p-1 w-1/3 type-val bg-gray-50" onchange="calculateTotals()">
                        <option value="erection">Erec</option>
                        <option value="dismantling">Dism</option>
                    </select>
                    <button onclick="this.closest('.measurement-row').remove(); calculateTotals()" class="text-red-500"><i class="fas fa-trash"></i></button>
                </div>
                <div class="grid grid-cols-4 gap-1">
                    <input type="number" placeholder="L" class="text-xs border p-1 text-center val-l" oninput="calculateTotals()">
                    <input type="number" placeholder="W" class="text-xs border p-1 text-center val-w" oninput="calculateTotals()">
                    <input type="number" placeholder="H" class="text-xs border p-1 text-center val-h" oninput="calculateTotals()">
                    <input type="number" placeholder="Q" class="text-xs border p-1 text-center val-q bg-yellow-50" oninput="calculateTotals()">
                </div>
            `;
            document.getElementById('measurement-container').appendChild(div);
        }

        // --- CHECK OUT: CALCULATIONS & PACKAGING ---
        function getCheckoutData() {
            let totErec = 0, totDism = 0;
            let measurementList = [];

            // 1. Gather Measurement Details
            document.querySelectorAll('.measurement-row').forEach(row => {
                const area = row.querySelector('.area-val').value;
                const type = row.querySelector('.type-val').value;
                const l = parseFloat(row.querySelector('.val-l').value) || 0;
                const w = parseFloat(row.querySelector('.val-w').value) || 0;
                const h = parseFloat(row.querySelector('.val-h').value) || 0;
                const q = parseFloat(row.querySelector('.val-q').value) || 0;

                let vol = l * w * h * q;
                
                // Push detailed row data
                measurementList.push({
                    area: area, type: type, l: l, w: w, h: h, q: q, vol: (type === 'dismantling' ? vol/2 : vol)
                });

                if (type === 'erection') totErec += vol;
                else totDism += (vol / 2); 
            });

            // 2. Gather OT Details
            const otChecks = document.querySelectorAll('#ot-worker-list input:checked');
            const otDetails = Array.from(otChecks).map(c => ({
                name: c.dataset.name,
                code: c.value
            }));

            // 3. Totals
            const manpower = parseInt(document.getElementById('co-manpower').value) || 0;
            const totalManhours = (manpower * 8) + otDetails.length; 
            const prod = totalManhours > 0 ? ((totErec + totDism) / totalManhours).toFixed(2) : 0;

            return {
                summary: { totErec, totDism, manpower, otCount: otDetails.length, totalManhours, prod },
                measurements: measurementList,
                otDetails: otDetails
            };
        }

        function calculateTotals() {
            const data = getCheckoutData();
            document.getElementById('disp-erection').innerText = data.summary.totErec.toFixed(2);
            document.getElementById('disp-dismantling').innerText = data.summary.totDism.toFixed(2);
            document.getElementById('disp-manhours').innerText = data.summary.totalManhours;
            document.getElementById('disp-prod').innerText = data.summary.prod;
        }

        async function submitCheckOut() {
            const proj = document.getElementById('co-project').value;
            const data = getCheckoutData(); 

            document.getElementById('co-loader').classList.remove('hidden');

            try {
                await postData({
                    action: "submitCheckOut",
                    supervisor: currentUser,
                    project: proj,
                    summary: data.summary,          
                    measurements: data.measurements,
                    otDetails: data.otDetails       
                });

                const date = new Date().toLocaleDateString();
                const txt = `üìã *DAILY REPORT*\nüìÖ ${date}\nüë∑ Sup: ${currentUser}\nüèóÔ∏è Proj: ${proj}\n\nErection: ${data.summary.totErec}\nDismantling: ${data.summary.totDism}\nManpower: ${data.summary.manpower}\nOT Staff: ${data.summary.otCount}\nManhours: ${data.summary.totalManhours}\nProductivity: ${data.summary.prod}`;
                showReport(txt);
            } catch(e) { notify("Error submitting report"); }
            
            document.getElementById('co-loader').classList.add('hidden');
        }

        // --- REPORTING ---
        function showReport(txt) {
            document.getElementById('report-text').value = txt;
            document.getElementById('report-modal').classList.remove('hidden');
        }
        function closeReport() { document.getElementById('report-modal').classList.add('hidden'); }
        function copyReport() {
            const txt = document.getElementById('report-text');
            txt.select();
            document.execCommand("copy");
            notify("Copied");
        }
        function shareWhatsapp() {
            const txt = document.getElementById('report-text').value;
            window.open(`https://wa.me/?text=${encodeURIComponent(txt)}`, '_blank');
        }
    </script>
</body>
</html>
