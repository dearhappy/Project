<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attendance Web App</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f0f2f5; padding-top: 20px; }
        .attendance-card {
            max-width: 450px;
            margin: auto;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            background: #fff;
            padding: 25px;
        }
        .hidden { display: none; }
        .worker-item { font-size: 0.9rem; display: flex; justify-content: space-between; align-items: center; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 30px; height: 30px; animation: spin 2s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div class="container">
        <div class="attendance-card">
            <h4 class="text-center text-primary mb-4">Worker Check-In</h4>
            
            <div id="loading" class="text-center mb-3">
                <div class="loader"></div>
                <p>Syncing Data...</p>
            </div>

            <div id="loginSection" class="hidden">
                <div class="mb-3">
                    <input type="text" id="username" class="form-control" placeholder="Supervisor Username">
                </div>
                <div class="mb-3">
                    <input type="password" id="passcode" class="form-control" placeholder="Passcode">
                </div>
                <button class="btn btn-primary w-100" onclick="handleLogin()">Login</button>
            </div>

            <div id="mainApp" class="hidden">
                <p class="text-muted small mb-1">Supervisor: <strong id="displaySup"></strong></p>
                <div class="mb-3">
                    <label class="form-label small">Select Working Area</label>
                    <select id="areaSelect" class="form-select"></select>
                </div>

                <hr>

                <div class="mb-3">
                    <label class="form-label small">Select Worker</label>
                    <select id="workerSelect" class="form-select mb-2"></select>
                    <button class="btn btn-outline-primary btn-sm w-100" onclick="addToList()">+ Add Worker</button>
                </div>

                <div class="mb-3">
                    <label class="small fw-bold">Check-in List:</label>
                    <ul id="selectedList" class="list-group">
                        </ul>
                </div>

                <button class="btn btn-success w-100 mb-2" id="submitBtn" onclick="submitFinal()">Submit Attendance</button>
            </div>
        </div>
    </div>

    <script>
        let sheetData = {};
        let attendanceList = [];

        // 1. Fetch data from Google Sheet on Load
        window.onload = function() {
            google.script.run.withSuccessHandler(function(data) {
                if(data.error) {
                    alert("Error: " + data.error);
                    return;
                }
                sheetData = data;
                populateDropdowns();
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('loginSection').classList.remove('hidden');
            }).getData();
        };

        function populateDropdowns() {
            const areaDrop = document.getElementById('areaSelect');
            sheetData.areas.forEach(a => areaDrop.innerHTML += `<option value="${a}">${a}</option>`);

            const workerDrop = document.getElementById('workerSelect');
            sheetData.workers.forEach(w => {
                workerDrop.innerHTML += `<option value="${w.code}">${w.name} (${w.code})</option>`;
            });
        }

        // 2. Login Logic
        function handleLogin() {
            const u = document.getElementById('username').value;
            const p = document.getElementById('passcode').value;
            const user = sheetData.users.find(x => x.user === u && x.pass === p);

            if (user) {
                document.getElementById('displaySup').innerText = u;
                document.getElementById('loginSection').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');
            } else {
                alert("Incorrect Username or Passcode");
            }
        }

        // 3. Add worker to temporary list
        function addToList() {
            const sel = document.getElementById('workerSelect');
            const nameCode = sel.options[sel.selectedIndex].text;
            const code = sel.value;
            const name = nameCode.split(' (')[0];

            if (attendanceList.some(item => item.code === code)) {
                alert("Worker already added");
                return;
            }

            attendanceList.push({name: name, code: code});
            updateUIList();
        }

        function updateUIList() {
            const listEl = document.getElementById('selectedList');
            listEl.innerHTML = attendanceList.map((w, index) => `
                <li class="list-group-item worker-item">
                    ${index + 1}. ${w.name} [${w.code}]
                    <button class="btn btn-sm btn-link text-danger" onclick="removeItem(${index})">Remove</button>
                </li>
            `).join('');
        }

        function removeItem(index) {
            attendanceList.splice(index, 1);
            updateUIList();
        }

        // 4. Submit to Google Sheet & Generate WhatsApp Report
        function submitFinal() {
            if (attendanceList.length === 0) return alert("Please add at least one worker.");
            
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.innerText = "Processing...";

            const payload = {
                supervisor: document.getElementById('username').value,
                area: document.getElementById('areaSelect').value,
                workers: attendanceList
            };

            google.script.run.withSuccessHandler(function() {
                generateReport(payload);
            }).submitAttendance(payload);
        }

        function generateReport(data) {
            const dateStr = new Date().toLocaleDateString();
            let report = `CHECK IN REPORT\nDate: ${dateStr}\nSupervisor: ${data.supervisor}\nArea: ${data.area}\n\n`;
            
            data.workers.forEach((w, i) => {
                report += `${i + 1}. ${w.name}\n`;
            });

            // Trigger WhatsApp
            const whatsappUrl = `https://api.whatsapp.com/send?text=${encodeURIComponent(report)}`;
            window.open(whatsappUrl, '_blank');

            alert("Data Saved Successfully!");
            location.reload();
        }
    </script>
</body>
</html>
